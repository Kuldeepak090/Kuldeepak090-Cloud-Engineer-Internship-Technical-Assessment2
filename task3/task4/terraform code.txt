AWSTemplateFormatVersion: "2010-09-09"
Description: Billing Alarm at ?100 (approx $1.20)

Parameters:
  EmailAddress:
    Type: String
    Description: Email address for receiving billing alerts

Resources:

  BillingAlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: BillingAlarmTopic
      Subscription:
        - Protocol: email
          Endpoint: !Ref EmailAddress

  BillingAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Alarm when AWS billing exceeds ?100 (~$1.20)"
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Dimensions:
        - Name: Currency
          Value: USD
      Statistic: Maximum
      Period: 21600          # 6 hours
      EvaluationPeriods: 1
      Threshold: 1.20        # USD equivalent of ?100
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref BillingAlarmTopic
      TreatMissingData: notBreaching

Outputs:
  AlarmName:
    Value: !Ref BillingAlarm
  SNSSubscription:
    Value: !Ref BillingAlarmTopic
